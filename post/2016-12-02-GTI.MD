---
layout: post
title:  "Buidling 'Big Data Platform' for a leading Smart City solution"
author: "Tory Xu"
author-link: "#"
#author-image: "{{ site.baseurl }}/images/authors/photo.jpg"
date:   2016-12-02
categories: IoT
color: "blue"
#image: "{{ site.baseurl }}/images/imagename.png" #should be ~350px tall
excerpt: Microsoft teamed up with GTI, a leading IoT platform and service provider and headquartered in Beijing, to develop the 'Big Data platform' used in its Smart City solution, which empowers the capability of 'Data Insights' for its customer requirements. 
language: English
verticals: Cross-industries
---

Microsoft teamed up with GTI, a leading IoT platform and service provider and headquartered in Beijing, to develop the 'Big Data platform' used in its Smart City solution, which empowers the capability of 'Data Insights' for its customer requirements. 

## Customer ##
[GTI](http://www.bd-gti.com/) is a leading IoT platform and service provider in China. Its business includes chipset and hardware manufacturing, communication networking, application development, and the operation of IoT-dedicated cloud service, which are broadly used in many scenarios around 'Smart Device, Better Life', like Smart City.  
 
## Pain point ##

GTI Smart City solution is built for the city management in Smart first world, including security, gas, electronic, parking, lamp, etc, and running in on-promise datacenter powered by Huawei solution. 

The pain points are around ‘Big Data’, including how to collect million-level data from multi sensors & devices, how to do the data analysis in real-time, how to dig out the value of the accumulated data, and how to present the insight of data for better city management.  

The storage and analysis of history data is another paint point for the solution and platform operations because all of data before the last month needs to be stored persistent. GTI wants to have one-stop data warehouse to store them and have the capability for data analysis in the future.
 
## Solution ##

1.	Use Azure IoT Hub to collect data generated by thousands or hundrends sensors and devices and send to the uniform management platform for daily monitoring. This will help the users to monitor the devices status and be notified if any issue or alert happened in real-time, which can speed up the response time for urgent event and help for the cost savings on operation side.

2.	Use Azure storage, especially DocumentDB, to store all of history data generated from all channels & customers, which help to save the storage cost and realize the future data insights when needed.

In the Smart City solution, GTI will use the following Microsoft technologies on Azure: 

- IoT Hub
- Stream Analytics
- SQL Database
- DocumentDB
- Power BI
- Notification Hub

## Architecture ##

The GTI Smart City solution architecture can be represented as follows:

- Over thousands sensors will be deployed in each customer project for monitoring and controlling the selected business scenarios, including illumination management, parking, facility monitoring, water and etc. The data collected include device status, temperature, presure, speed, and customized info.

- The Gateway is the hub to connect to all sensors via private protocal for security needed, and send the sensor data to the Azure IoT Hub each 5 or 10 or 15 seconds depending on the requirements of each business scenarios.

- Stream Analytic will transfer the data in to different storages, including SQL Server, DocumentDB, and even files.

- DocumentDB is also be used to store the history data transferred from SQL Server of the existed projects.


*Figure 001. GTI Smart City overview architecture*

![Smart City overview architecture]({{ site.baseurl }}/images/GTI_001.PNG)

*Figure 002. GTI Smart City data platform architecture*

![Smart City data platform architecture]({{ site.baseurl }}/images/GTI_002.PNG)

**Note:** Power BI is not generally available in China; Stream Analytics can't configure Power BI as an output stream in this phase.

## Device used and code artifacts ##

The v-team grouped with Microsoft China DX TE team and GTI dev team split the engagement into four segments:

- GTI Gateway IoT SDK integration
- History data storage in DocumentDB
- The deployment of IoT Hub, Stream Analytic, and DocumentDB
- Data visualization in Power BI

### Gateway IoT SDK integration ###

The GTI team focused on the Azure IoT Hub SDK integration with GTI Gateways, which have 2 models, one is based on RasberryPi and the other is based on . Both OSs are Linux. The Microsoft DX team helped the GTI hardware team to code the Azure IoT Hub SDK in their client, set up and register the gateway with the Azure IoT Hub, connect with the Azure IoT Hub, and send all sensors data to the Azure IoT Hub. The Linux client code screenshot is as follows:

```java
package com.gumpcome.iot;
import android.os.SystemClock;

import com.gumpcome.kernel.debug.GumpLog;
import com.microsoft.azure.iothub.IotHubEventCallback;
import com.microsoft.azure.iothub.IotHubStatusCode;
import com.microsoft.azure.iothub.DeviceClient;
import com.microsoft.azure.iothub.IotHubClientProtocol;
import com.microsoft.azure.iothub.IotHubEventCallback;
import com.microsoft.azure.iothub.IotHubMessageResult;
import com.microsoft.azure.iothub.IotHubStatusCode;
import com.microsoft.azure.iothub.Message;
import com.microsoft.azure.iothub.MessageCallback;

import java.io.IOException;
import java.net.URISyntaxException;

/**
 * @author LiuPeng @GumpCome
 *         LiuShijun @ Microsoft
 *         Created at 2016/8/30.
 */
public class IotHelper {
    private static final String TAG = "IotHelper";
    String connString = "HostName=iotxxx.azure-devices.cn;DeviceId=myFirstJavaDevice;SharedAccessKey=od1/RiE0ItHtbuewQ/xxxxxxxx";

    public void SendMessage(String message) throws URISyntaxException, IOException {
        IotHubClientProtocol protocol = IotHubClientProtocol.AMQPS;
        DeviceClient client = new DeviceClient(connString, protocol);

        try {
            client.open();
        } catch (IOException e) {
            GumpLog.e(TAG, "Iot连接异常:" + e.toString());
        }
        try {
            Message msg = new Message(message);
            msg.setProperty("messageCount", Integer.toString(1));
            System.out.println(message);
            EventCallback eventCallback = new EventCallback();
            client.sendEventAsync(msg, eventCallback, 1);
        } catch (Exception e) {
        }
        SystemClock.sleep(2000);
        client.close();
    }

    protected static class EventCallback implements IotHubEventCallback {
        public void execute(IotHubStatusCode status, Object context) {
            Integer i = (Integer) context;
            GumpLog.d(TAG, "IoTHub 返回的消息 " + i.toString()
                    + " ，状态:" + status.name());
        }
    }

    public void receiveMessage() throws URISyntaxException, IOException {

        IotHubClientProtocol protocol = IotHubClientProtocol.AMQPS;

        DeviceClient client = new DeviceClient(connString, protocol);
        {
            MessageCallback callback = new MessageCallback();
            Counter counter = new Counter(0);
            client.setMessageCallback(callback, counter);
        }
        try {
            client.open();
        } catch (IOException e) {
            GumpLog.e(TAG, "Iot连接异常:" + e.toString());
        }
        SystemClock.sleep(2000);
        client.close();
    }

    protected static class MessageCallback implements com.microsoft.azure.iothub.MessageCallback {
        public IotHubMessageResult execute(Message msg, Object context) {
            Counter counter = (Counter) context;

            GumpLog.d(TAG,
                    "Iot收到的消息:" + counter.toString()
                            + ",内容: " + new String(msg.getBytes(), Message.DEFAULT_IOTHUB_MESSAGE_CHARSET));

            int switchVal = counter.get() % 3;
            IotHubMessageResult res;
            switch (switchVal) {
                case 0:
                    res = IotHubMessageResult.COMPLETE;
                    break;
                case 1:
                    res = IotHubMessageResult.ABANDON;
                    break;
                case 2:
                    res = IotHubMessageResult.REJECT;
                    break;
                default:
                    throw new IllegalStateException("Invalid message result specified.");
            }

            GumpLog.d(TAG, "Responding to message " + counter.toString() + " with " + res.name());

            counter.increment();

            return res;
        }
    }

    /**
     * 作为消息的回调
     */
    protected static class Counter {
        protected int num;

        public Counter(int num) {
            this.num = num;
        }

        public int get() {
            return this.num;
        }

        public void increment() {
            this.num++;
        }

        @Override
        public String toString() {
            return Integer.toString(this.num);
        }
    }
}
```

### History data storage ###

The GTI app dev team is reponsble for building up the one-stop datawarehouse for the persistent storage of history data, which are transfered from other sources and platforms. Microsoft DX team helped on the archtecture consultant and code the data transferring to DocumentDB. The csharp code is as follows:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using System.Net;
using Microsoft.Azure.Documents;
using Microsoft.Azure.Documents.Client;
using Newtonsoft.Json;
using DocumentDB;
using System.Threading;
using System.Configuration;

namespace TestDocumentDB
{
    class Program
    {
        private static string EndpointUri;
        private static string PrimaryKey;
     
        static void Main(string[] args)
        {
            try
            {
                //获取连接字符串
                GetConfig();
            }
            catch (Exception ex)
            {

                Console.WriteLine("请先检查连接字符串是否正确");
            }
            try
            {
                DocumentManager doc = new DocumentManager();
                //创建数据和集合
                doc.GetStartedDemo(EndpointUri,PrimaryKey).Wait();
                //上传数据
                int i = 0;
                while (true)
                {
                    DataLog datalog = new DataLog() { ID = Guid.NewGuid(), NodeOID = "1234"+i, SensorName = "温湿度", DValue =new Random().Next(0,45), CreateTime = DateTime.Now };//实际使用中调用接口获取最新的历史数据
                    doc.CreateDocument<DataLog>(datalog,datalog.ID.ToString()).Wait();

                    i ++;
                    Thread.Sleep(1000);
                }

              //  p.GetStartedDemo().Wait();
            }
            catch (DocumentClientException de)
            {
                Exception baseException = de.GetBaseException();
                Console.WriteLine("{0} error occurred: {1}, Message: {2}", de.StatusCode, de.Message, baseException.Message);
            }
            catch (Exception e)
            {
                Exception baseException = e.GetBaseException();
                Console.WriteLine("Error: {0}, Message: {1}", e.Message, baseException.Message);
            }
            finally
            {
                Console.WriteLine("End of demo, press any key to exit.");
                Console.ReadKey();
            }
        }
      
        private static void GetConfig()
        {
            if ( !string.IsNullOrEmpty( ConfigurationManager.AppSettings["EndpointUri"]))
            {
                EndpointUri = ConfigurationManager.AppSettings["EndpointUri"];
            }
            if (!string.IsNullOrEmpty(ConfigurationManager.AppSettings["PrimaryKey"]))
            {
                PrimaryKey = ConfigurationManager.AppSettings["PrimaryKey"];
            }
        }

    }
}
```

### The deployment of Azure IoT Hub, Stream Analytics, and DocumentDB ###

In this segment, the Gump Come team deployed Azure IoT Hub, Stream Analytics, and Azure SQL Database on Azure. First, as a Gump Come proof of concept (POC) for Azure IoT Services, Gump Come created one free IoT Hub in their subscription, deployed Stream Analytics, and created their device status database on Azure SQL Database. Next, Gump Come technical decision makers, based on this POC result, plan to release this IoT solution to their 2,000+ production devices in China.

*Figure 011. Azure IoT Hub configuration in Azure*

![Azure IoT Hub Configuration in Azure]({{ site.baseurl }}/images/GTI_011.PNG)


*Figure 012. SA input streaming configuration in Azure*

![SA input streaming configuration in Azure]({{ site.baseurl }}/images/GTI_012.PNG)


*Figure 013. SA output streaming configuration in Azure*

![SA output streaming configuration in Azure]({{ site.baseurl }}/images/GTI_013.PNG)

*Figure 014. DocumentDB configuration in Azure*

![DocumentDB configuration in Azure]({{ site.baseurl }}/images/GTI_014.PNG)


## Opportunities created and going forward ##

Technical win drives business impaction is the engagement strategy.

### Technical excellence ###

The executives of GTI is planning to scale the Smart City solution to more cities in 10+ provinces in China in 2017. Also, Micro-device IoT platform is another strategy planned by GTI, which will provide the 'building block' capability for broadest developers or ISVs who want to build up its end-2-end IoT solution. The platform will be hosted on Azure. 

*Figure 021. Micro-device IoT platform*

![Micro-device IoT platform]({{ site.baseurl }}/images/GTI_021.PNG)

### Business impaction ###

The digital transformation of ‘GTI Smart City + Azure' is to make the better life for everyone. Both sides drives the broader customers engagement together via seting up the regular meetings and share the opportunities. As of Dec 2016, 2 sales Opportunities are created with China SMSP and PSG teams. The pictures of customer facing meetings as follows. 

*Figure 022. Co-selling to a MS customer with SMSP*

!Co-selling to a MS customer]({{ site.baseurl }}/images/GTI_022.PNG)

*Figure 023. Government opportunity engagment with PSG*

![Government opportunity engagement]({{ site.baseurl }}/images/GTI_023.PNG)

## Great team ##

*Figure 031. The executives meeting*

![Executives meeting]({{ site.baseurl }}/images/GTI_031.JPG)

*Figure 032. The GTI hackfest team*

![GTI hackfest team]({{ site.baseurl }}/images/GTI_032.JPG)

*Figure 033. The Smart City solution in Microsoft Technical Center*

![Smart City solution in Microsoft Technical Center]({{ site.baseurl }}/images/GTI_033.JPG)


Special thanks to the GTI team, the Microsoft China DX Technical Evangelist team, and the Microsoft Audience Evangelism team. 

This project team included the following participants:

* Haibo Lv –	GTI CTO
* Lin Zhang –	GTI Tech VP
* Junjie Bai –	GTI Backend Architect 
* He Li	–	GTI Hardware Engineer
* Yan Zhang – Microsoft DX Audience Evangelism Manager
* Michael Li –	Microsoft DX Technical Evangelist
* Shijun Liu –	Microsoft DX Technical Evangelist
* Tory Xu –	Microsoft DX Technical Evangelist


